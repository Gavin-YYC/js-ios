<!Doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0">
</head>
<body>
<h1>WebViewJavascriptBridge Demo</h1>
<script>
window.onload = function(){
  var oBtn = document.querySelector('#getData');
  var oSend = document.querySelector('#sendData');
  var oLog = document.querySelector('#logLine');
  var data = {
    name: 'Gavin',
    send: 'h5'
  };
  // 接收数据
  oBtn.addEventListener('click', function ( e ) {
    e.preventDefault();
    WebViewBridge.receive(function ( data ) {
      console.log("H5接收数据成功！");
      oLog.innerHTML = JSON.stringify( data );
    });
  })
  // 发送数据
  oSend.addEventListener('click', function ( e ) {
    e.preventDefault();
    WebViewBridge.send( data, function ( res ) {
      console.log("H5发送数据成功！");
      oLog.innerHTML = JSON.stringify( res );
    })
  })
}

/*
 * WebViewBridge
 * IOS 与 H5 数据沟通
 * https://github.com/marcuswestin/WebViewJavascriptBridge
 * 该示例是对官方Demo的封装，方法如下：
 * WebViewBridge.setBridge( callback )  建立桥接
 * WebViewBridge.receive( callback )    接受数据，接收一个回调，回调有一个data参数
 * WebViewBridge.send( data, callback ) 发送数据
 */
var WebViewBridge = {
  // 桥接名称
  handler: 'testJavascriptHandler',
  callback: 'testObjcCallback',
  // 建立
  setBridge: function ( callback ) {
    if ( window.WebViewJavascriptBridge ) {
      return callback( WebViewJavascriptBridge )
    }
    if ( window.WVJBCallbacks ) {
      return window.WVJBCallbacks.push(callback)
    }
    window.WVJBCallbacks = [callback]
    var WVJBIframe = document.createElement('iframe')
    WVJBIframe.style.display = 'none'
    WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__'
    document.documentElement.appendChild(WVJBIframe)
    setTimeout(function() { document.documentElement.removeChild(WVJBIframe) }, 0)
  },

  // 接收数据
  receive: function ( callback ) {
    var that = this
    this.setBridge(function ( bridge ) {
      // 接收从ios传来的信息
      bridge.registerHandler(that.handler, function ( data ) {
        callback.call( that, data )
      })
    })
  },

  // 发送数据
  // data 是 {}
  send: function ( data, callback ) {
    var that = this
    this.setBridge(function ( bridge ) {
      bridge.callHandler(that.callback, data, function ( res ) {
        callback.call(that, res)
      })
    })
  }
}
</script>
<button id="getData">获取数据</button>
<button id="sendData">发送数据</button>
<div id="logLine"></div>
</body></html>
